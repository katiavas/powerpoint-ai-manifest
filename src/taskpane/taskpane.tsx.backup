import * as React from 'react';
import * as ReactDOM from 'react-dom';

interface SlideShape {
  id: string;
  type: string;
  left: number;
  top: number;
  width: number;
  height: number;
}

interface AIResponse {
  actions: Array<{
    shapeId: string;
    modifications: {
      left?: number;
      top?: number;
      width?: number;
      height?: number;
    };
  }>;
  explanation: string;
}

const App: React.FC = () => {
  const [prompt, setPrompt] = React.useState('');
  const [loading, setLoading] = React.useState(false);
  const [result, setResult] = React.useState('');
  const [error, setError] = React.useState('');
  const [apiKey, setApiKey] = React.useState('');
  const [showSettings, setShowSettings] = React.useState(false);

  React.useEffect(() => {
    // Load API key from settings
    Office.onReady(() => {
      Office.context.document.settings.refreshAsync(() => {
        const savedKey = Office.context.document.settings.get('anthropicApiKey');
        if (savedKey) {
          setApiKey(savedKey);
        } else {
          setShowSettings(true);
        }
      });
    });
  }, []);

  const saveApiKey = () => {
    Office.context.document.settings.set('anthropicApiKey', apiKey);
    Office.context.document.settings.saveAsync(() => {
      setShowSettings(false);
      setError('');
    });
  };

  const analyzeCurrentSlide = async (): Promise<{shapes: SlideShape[], slideWidth: number, slideHeight: number}> => {
    return new Promise((resolve, reject) => {
      PowerPoint.run(async (context) => {
        try {
          const slides = context.presentation.slides;
          slides.load('items');
          await context.sync();

          // Get the first slide (or you can get active slide)
          const slide = slides.items[0];
          const shapes = slide.shapes;
          
          shapes.load('items');
          await context.sync();

          const slideData: SlideShape[] = [];
          
          for (const shape of shapes.items) {
            shape.load('id,type,left,top,width,height');
          }
          
          await context.sync();

          for (const shape of shapes.items) {
            slideData.push({
              id: shape.id,
              type: shape.type,
              left: shape.left,
              top: shape.top,
              width: shape.width,
              height: shape.height
            });
          }

          // PowerPoint slide dimensions (standard 16:9)
          resolve({
            shapes: slideData,
            slideWidth: 960,
            slideHeight: 540
          });
        } catch (error) {
          reject(error);
        }
      });
    });
  };

  const getAIInstructions = async (userPrompt: string, slideData: any): Promise<AIResponse> => {
    if (!apiKey) {
      throw new Error('Please set your Anthropic API key in settings');
    }

    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': apiKey,
        'anthropic-version': '2023-06-01'
      },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 2000,
        messages: [
          {
            role: 'user',
            content: `You are a PowerPoint formatting assistant. Analyze this slide and provide formatting instructions.

Current slide data:
${JSON.stringify(slideData, null, 2)}

User request: "${userPrompt}"

Provide ONLY a JSON response with formatting instructions. No explanations outside the JSON. Format:
{
  "actions": [
    {
      "shapeId": "shape_id_here",
      "modifications": {
        "left": number (optional, in points),
        "top": number (optional, in points),
        "width": number (optional, in points),
        "height": number (optional, in points)
      }
    }
  ],
  "explanation": "Brief explanation of what was done"
}

Important:
- Use the exact shape IDs from the slide data
- Calculate proper positions to align shapes
- Make dimensions uniform where requested
- Maintain reasonable spacing
- All measurements are in points`
          }
        ]
      })
    });

    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.error?.message || 'AI request failed');
    }

    const data = await response.json();
    const textContent = data.content.find((c: any) => c.type === 'text')?.text || '';
    
    // Remove markdown code blocks if present
    const jsonText = textContent.replace(/```json\n?|\n?```/g, '').trim();
    return JSON.parse(jsonText);
  };

  const applyFormatting = async (instructions: AIResponse): Promise<void> => {
    return new Promise((resolve, reject) => {
      PowerPoint.run(async (context) => {
        try {
          const slides = context.presentation.slides;
          slides.load('items');
          await context.sync();

          const slide = slides.items[0];
          const shapes = slide.shapes;
          shapes.load('items');
          await context.sync();

          // Apply each modification
          for (const action of instructions.actions) {
            const shape = shapes.items.find(s => s.id === action.shapeId);
            
            if (shape) {
              if (action.modifications.left !== undefined) {
                shape.left = action.modifications.left;
              }
              if (action.modifications.top !== undefined) {
                shape.top = action.modifications.top;
              }
              if (action.modifications.width !== undefined) {
                shape.width = action.modifications.width;
              }
              if (action.modifications.height !== undefined) {
                shape.height = action.modifications.height;
              }
            }
          }

          await context.sync();
          resolve();
        } catch (error) {
          reject(error);
        }
      });
    });
  };

  const handleFormat = async () => {
    if (!prompt.trim()) {
      setError('Please enter a formatting instruction');
      return;
    }

    if (!apiKey) {
      setError('Please set your Anthropic API key in settings');
      setShowSettings(true);
      return;
    }

    setLoading(true);
    setError('');
    setResult('');

    try {
      const slideAnalysis = await analyzeCurrentSlide();
      const aiInstructions = await getAIInstructions(prompt, slideAnalysis);
      await applyFormatting(aiInstructions);
      
      setResult(`âœ“ ${aiInstructions.explanation}`);
    } catch (err: any) {
      setError(err.message || 'An error occurred while formatting');
    } finally {
      setLoading(false);
    }
  };

  if (showSettings) {
    return (
      <div style={{ padding: '20px' }}>
        <h2>Settings</h2>
        <div style={{ marginBottom: '15px' }}>
          <label style={{ display: 'block', marginBottom: '5px' }}>
            Anthropic API Key:
          </label>
          <input
            type="password"
            value={apiKey}
            onChange={(e) => setApiKey(e.target.value)}
            style={{ width: '100%', padding: '8px' }}
            placeholder="sk-ant-..."
          />
        </div>
        <button onClick={saveApiKey} style={{ padding: '8px 16px' }}>
          Save Settings
        </button>
        <button 
          onClick={() => setShowSettings(false)} 
          style={{ padding: '8px 16px', marginLeft: '10px' }}
        >
          Cancel
        </button>
      </div>
    );
  }

  return (
    <div style={{ padding: '20px' }}>
      <div style={{ marginBottom: '20px' }}>
        <h2>AI Slide Formatter</h2>
        <button 
          onClick={() => setShowSettings(true)}
          style={{ fontSize: '12px', padding: '4px 8px' }}
        >
          Settings
        </button>
      </div>

      <div style={{ marginBottom: '15px' }}>
        <label style={{ display: 'block', marginBottom: '5px' }}>
          Formatting Instruction:
        </label>
        <textarea
          value={prompt}
          onChange={(e) => setPrompt(e.target.value)}
          placeholder="e.g., Align the charts in this slide and make them the same dimensions"
          style={{ width: '100%', padding: '8px', minHeight: '80px' }}
        />
      </div>

      <button
        onClick={handleFormat}
        disabled={loading}
        style={{
          width: '100%',
          padding: '12px',
          backgroundColor: loading ? '#ccc' : '#0078d4',
          color: 'white',
          border: 'none',
          cursor: loading ? 'not-allowed' : 'pointer'
        }}
      >
        {loading ? 'Formatting...' : 'Apply Formatting'}
      </button>

      {error && (
        <div style={{
          marginTop: '15px',
          padding: '10px',
          backgroundColor: '#fee',
          border: '1px solid #fcc',
          borderRadius: '4px',
          color: '#c00'
        }}>
          {error}
        </div>
      )}

      {result && (
        <div style={{
          marginTop: '15px',
          padding: '10px',
          backgroundColor: '#efe',
          border: '1px solid #cfc',
          borderRadius: '4px',
          color: '#060'
        }}>
          {result}
        </div>
      )}

      <div style={{ marginTop: '20px', fontSize: '12px', color: '#666' }}>
        <strong>Example prompts:</strong>
        <ul style={{ marginTop: '5px' }}>
          <li>Align all charts horizontally</li>
          <li>Make all images the same size</li>
          <li>Center all text boxes</li>
          <li>Distribute shapes evenly</li>
        </ul>
      </div>
    </div>
  );
};

// Initialize the add-in
Office.onReady(() => {
  ReactDOM.render(<App />, document.getElementById('container'));
});